---
- name: Create directory '/etc/nftables.d'
  ansible.builtin.file:
    path: '{{ arch_mnt }}/etc/nftables.d'
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Copy nftables ruleset to '/etc/nftables.conf'
  ansible.builtin.copy:
    dest: '{{ arch_mnt }}/etc/nftables.conf'
    content: |
      #!/usr/bin/nft -f

      flush ruleset

      table inet filter {

        chain input {
          type filter hook input priority 0; policy drop;

          # allow established/related connections
          ct state {established, related} accept

          # early drop of invalid connections
          ct state invalid drop

          # allow from loopback
          iifname lo accept

          # allow icmp
          ip protocol icmp accept
          meta l4proto ipv6-icmp accept

          # custom INPUT rules
          include "/etc/nftables.d/*.input.conf"

          # reject everything else
          reject with icmpx type port-unreachable
        }

        chain forward {
          type filter hook forward priority 0; policy drop;

          # custom FORWARD rules
          include "/etc/nftables.d/*.forward.conf"
        }

        chain output {
          type filter hook output priority 0; policy accept;

          # custom OUTPUT RULES
          include "/etc/nftables.d/*.output.conf"
        }

      }
    owner: root
    group: root
    mode: 0644
  notify: '{{ "enable" if bootstrap else "restart" }}_nftables'
